<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordle</title>
    <link rel="stylesheet" href="stile.css">
</head>
<body>
    <div id="header">
        <h1 id="titolo-missione">trova la parola</h1>
    </div>

    <div id="wordle-container">
        <h2 id="tentativiH">Tentativi per indovinare: <span id="tentativiSpan"></span></h2>
        <div id="griglia-wordle">
            <!--prima riga come esempio-->
            <div class="riga">
                <input id="l0" type="text" maxlength="1" class="lettera">
                <input id="l1" type="text" maxlength="1" class="lettera">
                <input id="l2" type="text" maxlength="1" class="lettera">
                <input id="l3" type="text" maxlength="1" class="lettera">
                <input id="l4" type="text" maxlength="1" class="lettera">
            </div>
            
            <p id="messaggio"></p>
            <p id="tentativi-info">Tentativi rimasti: <span id="tentativi-rimasti">5</span></p>
        </div>
        
        <button id="indietro-btn" class="action-button">Indietro</button>
    </div>
    
    <script>
        //onload dei dettagli di gioco
        function getDettagliGioco()
        {
            //numeroProva = localStorage.getItem("numeroProva");
            fetch('http://localhost:8080/missione4/dettagliGioco/' /* + numeroProva*/, 
            { method: 'GET' })  
                .then(response => response.json())
                .then(data => {
                    //estraggo i dettagli dal JSON restituito
                    var tentGiocoMax = data[0];
                    var tentGiocoFatti = data[1];

                    if (tentGiocoFatti >= tentGiocoMax)
                    {
                        ReindirizzamentoPrimaPagina();
                    }
                    else
                    {
                        //tentativi per indovinare
                        var tentSpan = document.getElementById("tentativiSpan");
                        tentSpan.innerText = str(int(tentGiocoMax) - int(tentGiocoFatti));
                    }
                
                })
                .catch(error => console.error("Si è verificato un errore:", error));
        }

        function controllaSoluzioni()
        {
            //ottengo numero prova
            numeroProva = localStorage.getItem("numeroProva");
            
            //inizializzo la variabile della risposta
            risp = "";

            //ottengo il tentativo di risposta
            for(var i = 0; i <= 5; i++)
            {
                var tempTxt = document.getElementById("l" + i);
                soluz += tempTxt.innerText;
            }

            //ottengo il numero del tentativo
            var tent = document.getElementById("tentativiSpan")

            fetch('http://localhost:8080/missione4/controlla/' + numeroProva, 
            {method: 'POST', body: JSON.stringify({tentativo: tent.innerText, risposta: risp})})
            .then(response => response.json())
            .then(data => {
                //estraggo i dettagli dal JSON restituito
                var risposta = data[0];

                if (risposta == "tentativi esauriti")
                {
                    ReindirizzamentoPrimaPagina();
                }   
                else if (risposta == "hai vinto!")
                {
                    alert("Complimenti, Hai vinto!!!");
                    ReindirizzamentoPrimaPagina();
                }
                else
                {
                    alert("Mi dispiace, non è la parola corretta... Riprova!");
                }

                //tentativi per indovinare
                var tentativiH = document.getElementById("tentativiH");
                tentativiH.innerText = "Tentativi per indovinare: " + str(int(tentGiocoMax) - int(tentGiocoFatti));
            
            })
            .catch(error => console.error("Si è verificato un errore:", error));
        }

        function ripristinaDati()
        {
            fetch('http://localhost:8080/missione4/resetGame', 
            { method: 'GET' })  
            .then(response => response.json())
                .then(data => {})
                .catch(error => console.error("Si è verificato un errore:", error));
        }


        function ReindirizzamentoPrimaPagina()
        {
            ripristinaDati();

            fetch('http://localhost:8080/missione4', 
            { method: 'GET' })  
            .then(response => response.json())
                .then(data => {})
                .catch(error => console.error("Si è verificato un errore:", error));
        }

        //carica gli indizi all'avvio della pagina
        window.onload = getDettagliGioco();

    </script>

    <!--chiamate rest
    <script>
        //onload dei tentativi rimasti
        function caricaTentativiRimasti() {
            fetch('http://localhost:8080/api/tentativi-rimasti', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('numero-tentativi').textContent = data.tentativiRimasti;
                })
                .catch(error => console.error("Si è verificato un errore:", error));
        }

        //prendere la parola dalla griglia unendo in un array le lettere e poi unirle in una stringa
        function getParolaDallaGriglia() {
            const lettere = document.querySelectorAll('.lettera');  //però qua prende tutta la griglia, va fatta solo la riga, vedi con monto
            return Array.from(lettere).map(input => input.value).join('');
        }

        //post della parola inserita per vedere se giusta
        document.getElementById('indovina').addEventListener('click', function () {
            const parola = getParolaDallaGriglia();

            fetch('http://localhost:8080/api/verifica-parola', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parola: parola })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.stato === 'vittoria') {
                        // Aggiorna la griglia con il tentativo corretto
                        aggiornaGriglia(tentativiFatti, data.risultato || Array.from(tentativo).map(l => ({lettera: l, stato: 'corretto'})));
                        
                        document.getElementById('messaggio').textContent = `Hai indovinato! Indizio ottenuto: ${data.indizio}`;
                        document.getElementById('messaggio').className = 'success-message';
                        
                        // Disabilita l'input e il pulsante dopo la vittoria
                        document.getElementById('parola-input').disabled = true;
                        document.getElementById('invia-btn').disabled = true;
                        
                        // Aggiungi pulsante per tornare alla pagina principale
                        const tornaBtn = document.createElement('button');
                        tornaBtn.textContent = 'Torna alla Pagina Principale';
                        tornaBtn.className = 'action-button';
                        tornaBtn.addEventListener('click', function() {
                            window.location.href = '/missione4';
                        });
                        document.getElementById('game-container').appendChild(tornaBtn);
                    } else if (data.stato === 'tentativo') {
                        // Aggiorna la griglia con il risultato del tentativo
                        aggiornaGriglia(tentativiFatti, data.risultato);
                        
                        tentativiFatti++;
                        document.getElementById('tentativi-rimasti').textContent = tentativiTotali - tentativiFatti;
                        document.getElementById('parola-input').value = '';
                        
                        if (tentativiFatti >= tentativiTotali) {
                            document.getElementById('messaggio').textContent = 'Hai esaurito i tentativi!';
                            document.getElementById('messaggio').className = 'error-message';
                            document.getElementById('parola-input').disabled = true;
                            document.getElementById('invia-btn').disabled = true;
                        }
                    } else {
                        // Gestisci errori
                        document.getElementById('messaggio').textContent = data.messaggio || 'Si è verificato un errore';
                        document.getElementById('messaggio').className = 'error-message';
                    }
                })
                .catch(error => {
                    console.error('Errore nell\'invio del tentativo:', error);
                    alert('Si è verificato un errore. Riprova più tardi.');
                });
            });
            
            function aggiornaGriglia(riga, risultato) {
                const rows = document.querySelectorAll('.grid-row');
                if (riga < rows.length) {
                    const cells = rows[riga].querySelectorAll('.grid-cell');
                    
                    for (let i = 0; i < risultato.length && i < cells.length; i++) {
                        cells[i].textContent = risultato[i].lettera;
                        cells[i].classList.add(risultato[i].stato);
                    }
                }
            }
            
            // Event listener per il pulsante Indietro
            document.getElementById('indietro-btn').addEventListener('click', function() {
                window.location.href = '/missione4';
            });
        });
    </script>
</body>
</html>
